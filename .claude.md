# Claude Context for MCP Server Project

## Project Overview
This is a production-ready Model Context Protocol (MCP) server implementation in C# following Clean Architecture principles. The server supports multiple transports (stdio, SSE, WebSocket) and implements the full MCP specification with enterprise-grade features.

## Key Architecture Patterns

### Clean Architecture Layers
1. **Domain Layer** (`src/McpServer.Domain/`) - Core business logic, no dependencies
2. **Application Layer** (`src/McpServer.Application/`) - Orchestration and use cases
3. **Infrastructure Layer** (`src/McpServer.Infrastructure/`) - External concerns and implementations
4. **Presentation Layer** (`src/McpServer.Web/`, `src/McpServer.Console/`) - Entry points

### Critical Design Decisions
- **Multi-Transport Architecture**: Simultaneous support for stdio, SSE, and WebSocket
- **Connection Multiplexing**: Single server instance handles multiple client connections
- **Caching Strategy**: In-memory caching with configurable distributed cache support
- **Authentication**: Multiple providers (API Key, JWT, OAuth, Session-based)
- **High Availability**: Circuit breakers, retry policies, and failover mechanisms

## Quick Navigation

### Core Components
- **Message Handlers**: `src/McpServer.Application/Handlers/` - All MCP message type handlers
- **Transport Layer**: `src/McpServer.Infrastructure/Transport/` - Transport implementations
- **Security**: `src/McpServer.Infrastructure/Security/` - Authentication providers
- **Tools**: `src/McpServer.Infrastructure/Tools/` - Built-in tool implementations
- **Resources**: `src/McpServer.Infrastructure/Resources/` - Resource providers

### Configuration Files
- **Main Config**: `appsettings.json` - Core server settings
- **Auth Config**: `appsettings.Authentication.json` - Authentication settings
- **OAuth Config**: `appsettings.OAuth.json` - OAuth provider configurations
- **Rate Limiting**: `appsettings.RateLimiting.json` - Rate limit rules
- **Connection Multiplexing**: `appsettings.ConnectionMultiplexing.json` - Multi-connection settings

### Entry Points
- **Web Server**: `src/McpServer.Web/Program.cs` - ASP.NET Core host for SSE/WebSocket
- **Console App**: `src/McpServer.Console/Program.cs` - CLI host for stdio transport

## Common Tasks

### Adding a New Tool
1. Create tool class in `src/McpServer.Infrastructure/Tools/`
2. Implement `ITool` interface from `src/McpServer.Domain/Tools/`
3. Register in DI container (auto-registered if decorated with `[Tool]` attribute)
4. Add tests in `tests/McpServer.Infrastructure.Tests/Tools/`

### Adding a New Resource Provider
1. Create provider in `src/McpServer.Infrastructure/Resources/`
2. Implement `IResourceProvider` interface
3. Register in DI container
4. Add subscription support if needed

### Adding a New Message Handler
1. Create handler in `src/McpServer.Application/Handlers/`
2. Implement `IMessageHandler<TRequest, TResponse>`
3. Handler is auto-discovered by `MessageRouter`
4. Add tests in `tests/McpServer.Application.Tests/Handlers/`

### Implementing a New Transport
1. Create transport in `src/McpServer.Infrastructure/Transport/`
2. Implement `ITransport` interface
3. Update `TransportManager` to support new transport type
4. Add transport-specific configuration

## Performance Considerations

### Large Files to Avoid Loading Entirely
- Log files in `logs/` directories
- Binary files in `bin/` and `obj/` directories
- NuGet packages in `.nuget/` directories
- Test result files (`*.trx`, `*.coverage`)

### Caching Points
- Tool results are cached via `ToolResultCache`
- Resource contents are cached via `ResourceContentCache`
- Authentication tokens are cached in memory
- Configuration is cached and supports hot-reload

### High-Traffic Components
- `MessageRouter` - Handles all message routing
- `ConnectionManager` - Manages all active connections
- `RateLimiter` - Processes every request
- `ValidationService` - Validates all messages

## Security Boundaries

### Authentication Flow
1. Request arrives at transport layer
2. `AuthenticationMiddleware` validates credentials
3. `AuthenticationService` verifies against configured provider
4. Session is created and cached
5. Subsequent requests use session token

### Critical Security Components
- `src/McpServer.Application/Middleware/AuthenticationMiddleware.cs`
- `src/McpServer.Infrastructure/Security/` - All auth providers
- `src/McpServer.Application/Services/SessionService.cs`
- `src/McpServer.Application/Middleware/RateLimitingMiddleware.cs`

## Testing Strategy

### Test Organization
- **Unit Tests**: Test individual components in isolation
- **Integration Tests**: Test cross-layer interactions
- **Web Tests**: Test HTTP/SSE/WebSocket endpoints
- **Performance Tests**: Load and stress testing

### Running Tests
```bash
# All tests
dotnet test

# Specific test project
dotnet test tests/McpServer.Application.Tests

# With coverage
dotnet test --collect:"XPlat Code Coverage"
```

## Common Issues and Solutions

### Connection Issues
- Check transport configuration in appsettings
- Verify CORS settings for web transports
- Check firewall/port availability

### Authentication Failures
- Verify provider configuration
- Check token expiration settings
- Validate OAuth redirect URIs

### Performance Problems
- Enable caching if disabled
- Check rate limiting settings
- Monitor circuit breaker states
- Review connection pool limits

## Dependencies and Package Management

### Key NuGet Packages
- `Microsoft.Extensions.*` - Core framework
- `FluentValidation` - Input validation
- `Serilog` - Structured logging
- `OpenTelemetry` - Observability
- `System.Text.Json` - JSON serialization

### Version Management
- .NET 8.0 SDK required
- Global packages defined in `Directory.Build.props`
- Package versions centrally managed

## Development Workflow

### Local Development
```bash
# Run web server (SSE/WebSocket)
cd src/McpServer.Web
dotnet run

# Run console (stdio)
cd src/McpServer.Console
dotnet run
```

### Docker Development
```bash
# Build and run all services
docker-compose -f docker-compose.dev.yml up

# Run specific transport
docker-compose -f docker-compose.dev.yml up mcpserver-web
```

### Code Style
- Follow C# coding conventions
- Use nullable reference types
- Implement async/await properly
- Follow SOLID principles
- Document public APIs with XML comments

## Monitoring and Observability

### Health Checks
- `/health` - Basic health status
- `/health/ready` - Readiness probe
- `/health/live` - Liveness probe

### Metrics Endpoints
- `/metrics` - Prometheus metrics
- `/monitoring/connections` - Active connections
- `/monitoring/stats` - Server statistics

### Logging
- Structured logging via Serilog
- Log files in `logs/` directory
- Configurable log levels per namespace
- Correlation IDs for request tracking

## Related Documentation
- `CODEBASE_INDEX.md` - Detailed file structure
- `docs/INDEX_TRANSPORT.md` - Transport layer details
- `docs/INDEX_HANDLERS.md` - Message handler guide
- `docs/INDEX_SECURITY.md` - Security implementation
- `docs/INDEX_TOOLS.md` - Tools system guide
- `docs/COMMON_PATTERNS.md` - Code patterns and snippets
- `docs/PERFORMANCE_NOTES.md` - Performance optimization
- `docs/QUICK_FIXES.md` - Common issue solutions